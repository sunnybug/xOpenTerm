# 发布：main/master 推送时若 csproj 版本号大于已有 tag，则自动打 tag 并构建、发布到 GitHub Release
name: Publish

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.compare.outputs.should_tag }}
      version: ${{ steps.version.outputs.current }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 解析 csproj 版本
        id: version
        run: |
          V=$(grep -oP '<Version>\K[^<]+' src/xOpenTerm.csproj)
          echo "current=$V" >> $GITHUB_OUTPUT
          echo "当前版本: $V"

      - name: 获取已有 tag 并比较
        id: compare
        run: |
          git fetch --tags
          LATEST=$(git tag -l 'v*' | sed 's/^v//' | sort -t. -k1,1n -k2,2n -k3,3n | tail -n1)
          CURRENT="${{ steps.version.outputs.current }}"
          if [ -z "$LATEST" ] || [ "$(printf '%s\n%s' "$LATEST" "$CURRENT" | sort -V | tail -n1)" = "$CURRENT" ] && [ "$CURRENT" != "$LATEST" ]; then
            echo "should_tag=true" >> $GITHUB_OUTPUT
            echo "将发布: v$CURRENT (已有最新: v${LATEST:-无})"
          else
            echo "should_tag=false" >> $GITHUB_OUTPUT
            echo "跳过发布，当前版本 $CURRENT 未大于已有 v* tag"
          fi

      - name: 创建并推送 tag
        if: steps.compare.outputs.should_tag == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          V="${{ steps.version.outputs.current }}"
          git tag "v$V"
          git push origin "v$V"

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 生成 RDP 互操作程序集
        run: .\script\gen_mstsc_interop.ps1
        shell: pwsh

      - name: 构建 Release
        run: dotnet build src/xOpenTerm.csproj -c Release

      - name: 发布到 dist
        run: |
          $version = "${{ needs.check-version.outputs.version }}"
          New-Item -ItemType Directory -Path dist -Force
          $out = "dist/xOpenTerm-v$version"
          New-Item -ItemType Directory -Path $out -Force
          Copy-Item -Path "bin/Release/net8.0-windows/*" -Destination $out -Recurse -Force
        shell: pwsh

      - name: 打包 Release 压缩包
        run: |
          $version = "${{ needs.check-version.outputs.version }}"
          $zipName = "xOpenTerm-v$version.zip"
          Compress-Archive -Path "dist/xOpenTerm-v$version/*" -DestinationPath $zipName -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        shell: pwsh

      - name: 创建 GitHub Release 并上传
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: xOpenTerm v${{ needs.check-version.outputs.version }}
          files: ${{ env.ZIP_NAME }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传制品
        uses: actions/upload-artifact@v4
        with:
          name: xOpenTerm-v${{ needs.check-version.outputs.version }}
          path: dist/
